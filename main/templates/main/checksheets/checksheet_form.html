{% extends 'checksheets/base.html' %}

{% block page_icon %}fas fa-edit{% endblock %}

{% block content %}
<form method="post" id="checksheetForm">
    {% csrf_token %}
    
    <!-- Form Header with Instructions -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">
                        <i class="fas fa-clipboard-check"></i> {{ checksheet.name }}
                    </h4>
                    {% if checksheet.name_hindi %}
                    <p class="hindi-text mb-0">{{ checksheet.name_hindi }}</p>
                    {% endif %}
                    {% if checksheet.description %}
                    <p class="text-muted mt-2 mb-0">{{ checksheet.description }}</p>
                    {% endif %}
                </div>
                <div class="col-md-4 text-end">
                    {% if is_edit %}
                    <span class="badge status-badge status-{{ response.status }} fs-6">
                        {{ response.get_status_display }}
                    </span>
                    {% else %}
                    <span class="badge bg-secondary fs-6">New Entry</span>
                    {% endif %}
                </div>
            </div>
            
            {% if is_edit %}
            <hr>
            <div class="row text-center">
                <div class="col-md-4">
                    <small class="text-muted">Created By</small>
                    <p class="mb-0"><strong>{{ response.filled_by.username }}</strong></p>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Created At</small>
                    <p class="mb-0"><strong>{{ response.created_at|date:"Y-m-d H:i" }}</strong></p>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Last Updated</small>
                    <p class="mb-0"><strong>{{ response.updated_at|date:"Y-m-d H:i" }}</strong></p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Form Sections -->
    {% for section in sections %}
    <div class="form-section" id="section-{{ section.id }}">
        <div class="form-section-header">
            <i class="fas fa-folder-open"></i> 
            {{ section.order }}. {{ section.name }}
            {% if section.name_hindi %}
            <span style="opacity: 0.9; font-weight: 400; font-size: 0.95rem;">
                ({{ section.name_hindi }})
            </span>
            {% endif %}
        </div>

        {% if section.description %}
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle"></i> {{ section.description }}
        </div>
        {% endif %}

        <div class="row">
            {% for field in section.fields.all %}
            {% if is_edit %}
                {% with field_response=existing_responses|default_if_none:dict %}
                    {% with response_data=field_response|get_item:field.id %}
            {% endif %}
            
            <div class="col-md-{% if field.field_type == 'textarea' %}12{% elif field.has_status_field %}12{% else %}6{% endif %} mb-4">
                <div class="field-wrapper">
                    <!-- Field Label -->
                    <label class="form-label {% if field.is_required %}required-field{% endif %}">
                        {{ field.label }}
                        {% if field.label_hindi %}
                        <span class="hindi-text">({{ field.label_hindi }})</span>
                        {% endif %}
                    </label>

                    <!-- Auto-fill Indicator -->
                    {% if field.auto_fill_based_on_model %}
                    <div class="auto-fill-indicator" data-field-id="{{ field.id }}">
                        <i class="fas fa-magic"></i> This field will auto-fill based on model selection
                    </div>
                    {% endif %}

                    <!-- Help Text -->
                    {% if field.help_text %}
                    <small class="form-text text-muted d-block mb-2">
                        <i class="fas fa-question-circle"></i> {{ field.help_text }}
                        {% if field.help_text_hindi %}
                        <br>{{ field.help_text_hindi }}
                        {% endif %}
                    </small>
                    {% endif %}

                    <!-- Field Input based on type -->
                    {% if field.has_status_field %}
                    <div class="field-with-status">
                        <div>
                    {% endif %}

                    {% if field.field_type == 'text' %}
                        <input type="text" 
                               class="form-control" 
                               name="field_{{ field.id }}"
                               id="field_{{ field.id }}"
                               placeholder="{{ field.placeholder }}"
                               {% if field.is_required %}required{% endif %}
                               {% if field.auto_fill_based_on_model %}data-autofill="true"{% endif %}
                               value="{% if is_edit and response_data %}{{ response_data.value }}{% elif form_data %}{{ form_data|get_item:'field_'|add:field.id|stringformat:'s' }}{% else %}{{ field.default_value }}{% endif %}">

                    {% elif field.field_type == 'number' or field.field_type == 'decimal' %}
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   name="field_{{ field.id }}"
                                   id="field_{{ field.id }}"
                                   step="{% if field.field_type == 'decimal' %}0.01{% else %}1{% endif %}"
                                   {% if field.min_value %}min="{{ field.min_value }}"{% endif %}
                                   {% if field.max_value %}max="{{ field.max_value }}"{% endif %}
                                   placeholder="{{ field.placeholder }}"
                                   {% if field.is_required %}required{% endif %}
                                   value="{% if is_edit and response_data %}{{ response_data.value }}{% elif form_data %}{{ form_data|get_item:'field_'|add:field.id|stringformat:'s' }}{% else %}{{ field.default_value }}{% endif %}">
                            {% if field.unit %}
                            <span class="input-group-text">{{ field.unit }}</span>
                            {% endif %}
                        </div>
                        {% if field.min_value or field.max_value %}
                        <small class="form-text text-muted">
                            Range: {{ field.min_value|default:'−∞' }} to {{ field.max_value|default:'+∞' }} {{ field.unit }}
                        </small>
                        {% endif %}

                    {% elif field.field_type == 'dropdown' %}
                        <select class="form-select" 
                                name="field_{{ field.id }}"
                                id="field_{{ field.id }}"
                                {% if field.is_required %}required{% endif %}
                                {% if 'Program selection' in field.label or 'program' in field.label.lower %}onchange="handleModelChange(this.value)"{% endif %}>
                            <option value="">-- Select {{ field.label }} --</option>
                            {% for choice in field.get_choices_list %}
                            <option value="{{ choice }}" 
                                    {% if is_edit and response_data and response_data.value == choice %}selected{% endif %}
                                    {% if form_data and form_data|get_item:'field_'|add:field.id|stringformat:'s' == choice %}selected{% endif %}>
                                {{ choice }}
                            </option>
                            {% endfor %}
                        </select>

                    {% elif field.field_type == 'ok_nok' %}
                        <div class="btn-group w-100" role="group">
                            <input type="radio" 
                                   class="btn-check" 
                                   name="{% if field.has_status_field %}status_{{ field.id }}{% else %}field_{{ field.id }}{% endif %}" 
                                   id="ok_{{ field.id }}" 
                                   value="OK"
                                   {% if field.is_required %}required{% endif %}
                                   {% if is_edit and response_data %}
                                       {% if field.has_status_field and response_data.status == 'OK' %}checked{% endif %}
                                       {% if not field.has_status_field and response_data.value == 'OK' %}checked{% endif %}
                                   {% endif %}>
                            <label class="btn btn-outline-success" for="ok_{{ field.id }}">
                                <i class="fas fa-check-circle"></i> OK
                            </label>

                            <input type="radio" 
                                   class="btn-check" 
                                   name="{% if field.has_status_field %}status_{{ field.id }}{% else %}field_{{ field.id }}{% endif %}" 
                                   id="nok_{{ field.id }}" 
                                   value="NOK"
                                   {% if field.is_required %}required{% endif %}
                                   {% if is_edit and response_data %}
                                       {% if field.has_status_field and response_data.status == 'NOK' %}checked{% endif %}
                                       {% if not field.has_status_field and response_data.value == 'NOK' %}checked{% endif %}
                                   {% endif %}
                                   onchange="toggleCommentField({{ field.id }}, {{ field.requires_comment_if_nok|yesno:'true,false' }})">
                            <label class="btn btn-outline-danger" for="nok_{{ field.id }}">
                                <i class="fas fa-times-circle"></i> NOK
                            </label>
                        </div>

                    {% elif field.field_type == 'yes_no' %}
                        <div class="btn-group w-100" role="group">
                            <input type="radio" 
                                   class="btn-check" 
                                   name="field_{{ field.id }}" 
                                   id="yes_{{ field.id }}" 
                                   value="Yes"
                                   {% if field.is_required %}required{% endif %}
                                   {% if is_edit and response_data and response_data.value == 'Yes' %}checked{% endif %}>
                            <label class="btn btn-outline-success" for="yes_{{ field.id }}">
                                <i class="fas fa-check"></i> Yes
                            </label>

                            <input type="radio" 
                                   class="btn-check" 
                                   name="field_{{ field.id }}" 
                                   id="no_{{ field.id }}" 
                                   value="No"
                                   {% if field.is_required %}required{% endif %}
                                   {% if is_edit and response_data and response_data.value == 'No' %}checked{% endif %}
                                   onchange="toggleCommentField({{ field.id }}, {{ field.requires_comment_if_nok|yesno:'true,false' }})">
                            <label class="btn btn-outline-danger" for="no_{{ field.id }}">
                                <i class="fas fa-times"></i> No
                            </label>
                        </div>

                    {% elif field.field_type == 'date' %}
                        <input type="date" 
                               class="form-control" 
                               name="field_{{ field.id }}"
                               id="field_{{ field.id }}"
                               {% if field.is_required %}required{% endif %}
                               value="{% if is_edit and response_data %}{{ response_data.value }}{% elif form_data %}{{ form_data|get_item:'field_'|add:field.id|stringformat:'s' }}{% else %}{{ field.default_value }}{% endif %}">

                    {% elif field.field_type == 'time' %}
                        <input type="time" 
                               class="form-control" 
                               name="field_{{ field.id }}"
                               id="field_{{ field.id }}"
                               {% if field.is_required %}required{% endif %}
                               value="{% if is_edit and response_data %}{{ response_data.value }}{% elif form_data %}{{ form_data|get_item:'field_'|add:field.id|stringformat:'s' }}{% else %}{{ field.default_value }}{% endif %}">

                    {% elif field.field_type == 'datetime' %}
                        <input type="datetime-local" 
                               class="form-control" 
                               name="field_{{ field.id }}"
                               id="field_{{ field.id }}"
                               {% if field.is_required %}required{% endif %}
                               value="{% if is_edit and response_data %}{{ response_data.value }}{% elif form_data %}{{ form_data|get_item:'field_'|add:field.id|stringformat:'s' }}{% else %}{{ field.default_value }}{% endif %}">

                    {% elif field.field_type == 'checkbox' %}
                        <div class="form-check">
                            <input type="checkbox" 
                                   class="form-check-input" 
                                   name="field_{{ field.id }}"
                                   id="field_{{ field.id }}"
                                   value="checked"
                                   {% if field.is_required %}required{% endif %}
                                   {% if is_edit and response_data and response_data.value == 'checked' %}checked{% endif %}>
                            <label class="form-check-label" for="field_{{ field.id }}">
                                {{ field.placeholder|default:"Check this box" }}
                            </label>
                        </div>

                    {% elif field.field_type == 'textarea' %}
                        <textarea class="form-control" 
                                  name="field_{{ field.id }}"
                                  id="field_{{ field.id }}"
                                  rows="4"
                                  placeholder="{{ field.placeholder }}"
                                  {% if field.is_required %}required{% endif %}>{% if is_edit and response_data %}{{ response_data.value }}{% elif form_data %}{{ form_data|get_item:'field_'|add:field.id|stringformat:'s' }}{% else %}{{ field.default_value }}{% endif %}</textarea>

                    {% endif %}

                    {% if field.has_status_field and field.field_type != 'ok_nok' %}
                        </div>
                        <div>
                            <label class="form-label">Status</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" 
                                       class="btn-check" 
                                       name="status_{{ field.id }}" 
                                       id="status_ok_{{ field.id }}" 
                                       value="OK"
                                       {% if is_edit and response_data and response_data.status == 'OK' %}checked{% endif %}>
                                <label class="btn btn-outline-success" for="status_ok_{{ field.id }}">
                                    <i class="fas fa-check-circle"></i> OK
                                </label>

                                <input type="radio" 
                                       class="btn-check" 
                                       name="status_{{ field.id }}" 
                                       id="status_nok_{{ field.id }}" 
                                       value="NOK"
                                       {% if is_edit and response_data and response_data.status == 'NOK' %}checked{% endif %}
                                       onchange="toggleCommentField({{ field.id }}, {{ field.requires_comment_if_nok|yesno:'true,false' }})">
                                <label class="btn btn-outline-danger" for="status_nok_{{ field.id }}">
                                    <i class="fas fa-times-circle"></i> NOK
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Comment Field (shown when NOK is selected) -->
                    {% if field.requires_comment_if_nok or field.has_status_field %}
                    <div class="mt-3 comment-field" id="comment_field_{{ field.id }}" 
                         style="display: {% if is_edit and response_data and response_data.status == 'NOK' or is_edit and response_data and response_data.value == 'NOK' %}block{% else %}none{% endif %};">
                        <label class="form-label">
                            <i class="fas fa-comment"></i> Comment 
                            {% if field.requires_comment_if_nok %}
                            <span class="text-danger">(Required when NOK)</span>
                            {% endif %}
                        </label>
                        <textarea class="form-control" 
                                  name="comment_{{ field.id }}"
                                  id="comment_{{ field.id }}"
                                  rows="2"
                                  placeholder="Enter your comment here...">{% if is_edit and response_data %}{{ response_data.comment }}{% endif %}</textarea>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if is_edit %}
                    {% endwith %}
                {% endwith %}
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <!-- Form Actions -->
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <button type="submit" name="action" value="draft" class="btn btn-secondary btn-lg w-100">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="submit" name="action" value="submit" class="btn btn-success btn-lg w-100" onclick="return confirm('Are you sure you want to submit this checksheet? You will not be able to edit it after submission.')">
                        <i class="fas fa-paper-plane"></i> Submit for Approval
                    </button>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="{% url 'checksheet_responses_list' %}" class="btn btn-link">
                    <i class="fas fa-arrow-left"></i> Cancel and Go Back
                </a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Handle model selection change for auto-fill fields
function handleModelChange(selectedModel) {
    if (!selectedModel) return;
    
    console.log('Model selected:', selectedModel);
    
    // Find all fields with auto-fill
    const autoFillFields = document.querySelectorAll('[data-autofill="true"]');
    
    autoFillFields.forEach(field => {
        const fieldId = field.id.replace('field_', '');
        
        // Make AJAX request to get auto-fill value
        fetch(`{% url 'get_autofill_value' %}?field_id=${fieldId}&model=${selectedModel}`)
            .then(response => response.json())
            .then(data => {
                if (data.value) {
                    field.value = data.value;
                    // Add visual feedback
                    field.style.backgroundColor = '#e8f5e9';
                    setTimeout(() => {
                        field.style.backgroundColor = '';
                    }, 1000);
                }
            })
            .catch(error => console.error('Error fetching auto-fill value:', error));
    });
}

// Toggle comment field visibility
function toggleCommentField(fieldId, isRequired) {
    const commentField = document.getElementById(`comment_field_${fieldId}`);
    const nokRadio = document.getElementById(`nok_${fieldId}`) || 
                     document.getElementById(`status_nok_${fieldId}`) ||
                     document.getElementById(`no_${fieldId}`);
    
    if (commentField) {
        if (nokRadio && nokRadio.checked) {
            commentField.style.display = 'block';
            if (isRequired) {
                document.getElementById(`comment_${fieldId}`).required = true;
            }
        } else {
            commentField.style.display = 'none';
            document.getElementById(`comment_${fieldId}`).required = false;
        }
    }
}

// Form validation before submit
document.getElementById('checksheetForm').addEventListener('submit', function(e) {
    const action = e.submitter.value;
    
    if (action === 'submit') {
        // Additional validation for submit action
        let hasErrors = false;
        const requiredFields = this.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
            if (!field.value && field.type !== 'radio') {
                hasErrors = true;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        // Check radio groups
        const radioGroups = {};
        this.querySelectorAll('input[type="radio"][required]').forEach(radio => {
            if (!radioGroups[radio.name]) {
                radioGroups[radio.name] = [];
            }
            radioGroups[radio.name].push(radio);
        });
        
        Object.keys(radioGroups).forEach(groupName => {
            const group = radioGroups[groupName];
            const isChecked = group.some(radio => radio.checked);
            if (!isChecked) {
                hasErrors = true;
                group.forEach(radio => {
                    radio.parentElement.classList.add('is-invalid');
                });
            }
        });
        
        if (hasErrors) {
            e.preventDefault();
            alert('Please fill in all required fields before submitting.');
            // Scroll to first error
            const firstError = this.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }
});

// Initialize comment fields on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check all NOK radio buttons and show comment fields if needed
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        if (radio.value === 'NOK' || radio.value === 'No') {
            const fieldId = radio.id.replace('nok_', '').replace('status_nok_', '').replace('no_', '');
            const commentField = document.getElementById(`comment_field_${fieldId}`);
            if (commentField) {
                commentField.style.display = 'block';
            }
        }
    });
});

// Auto-save draft functionality (optional)
let autoSaveTimeout;
document.getElementById('checksheetForm').addEventListener('input', function() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        console.log('Auto-save triggered (implement if needed)');
        // You can implement auto-save to localStorage here
    }, 5000);
});
</script>

<style>
.is-invalid {
    border-color: #dc3545 !important;
}

.btn-check:checked + .btn-outline-success {
    background-color: var(--success-color);
    color: white;
}

.btn-check:checked + .btn-outline-danger {
    background-color: var(--danger-color);
    color: white;
}

.field-wrapper {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.comment-field {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}