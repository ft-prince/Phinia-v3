{% extends 'main/base.html' %}
{% load checksheet_filters %}

{% block title %}Operator Dashboard{% endblock %}

{% block extra_css %}
<style>
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .pulse-button {
        animation: pulse 2s infinite;
    }
    
    /* Compact styling */
    .card {
        margin-bottom: 1rem; /* Reduced spacing */
    }
    
    .card-header {
        padding: 0.5rem 1rem; /* Reduced padding */
    }
    
    .card-body {
        padding: 0.75rem 1rem; /* Reduced padding */
    }
    
    .compact-stats {
        display: flex;
        justify-content: space-around;
        align-items: center;
        gap: 1rem;
    }
    
    .stat-item {
        text-align: center;
        flex: 1;
    }
    
    .stat-value {
        font-size: 1.25rem;
        font-weight: bold;
        margin: 0;
    }
    
    .stat-label {
        font-size: 0.875rem;
        margin: 0;
    }
    
    .single-row-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .operator-info {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
    }
    
    .info-item {
        flex: 1;
        min-width: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Shift Information -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card shadow-sm" style="background-color: #000000; color: #FFFFFF;">
                <div class="card-header text-white" style="background-color: #CC0000;">
                    <h5 class="mb-0">Current Shift Information</h5>
                </div>
                <div class="card-body">
                    <div class="operator-info">
                        <div class="info-item">
                            <h6 class="text-danger">Current Time</h6>
                            <p class="h5 mb-0" id="currentTime">{{ current_time|time:"H:i" }}</p>
                        </div>
                        <div class="info-item">
                            <h6 class="text-danger">Date</h6>
                            <p class="mb-0">{{ current_date|date:"d M Y" }}</p>
                        </div>
                        <div class="info-item">
                            <h6 class="text-danger">Operator</h6>
                            <p class="mb-0">{{ request.user }}</p>
                        </div>
                        <div class="info-item">
                            <h6 class="text-danger">Operator Code</h6>
                            <p class="mb-0">{{ request.user.company_id }}</p>
                        </div>
                        <div class="info-item">
                            <h6 class="text-danger">Skill Level</h6>
                            <p class="mb-0">{{ request.user.skill_matrix_level }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Checklist Status -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card shadow-lg" style="background: linear-gradient(135deg, #111111, #222222); color: #fff;">
                <div class="card-header text-white" style="background-color: #990000;">
                    <h5 class="mb-0">Daily Verification/Inspection Sheet (DVIS) Check Sheet</h5>
                </div>
                <div class="card-body">
                    {% if active_checklist %}
                        <div class="text-center">
                            <div class="mb-2">
                                <i class="fas fa-clipboard-check text-success" style="font-size: 2rem;"></i>
                            </div>
                            <p class="text-success mb-2">✓ Active Verification Sheet</p>
                            <p class="text-muted small">Created at {{ active_checklist.created_at|date:"H:i" }}</p>
                            <a href="{% url 'checklist_detail' checklist_id=active_checklist.id %}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-eye me-1"></i> View Details
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center">
                            <div class="mb-2">
                                <i class="fas fa-clipboard-check text-danger" style="font-size: 2rem;"></i>
                            </div>
                            <p class="mb-3 text-danger">No active checklist for the current shift</p>
                            {% if can_create_new %}
                                <a href="{% url 'create_checklist' %}" class="btn btn-danger">
                                    <i class="fas fa-plus me-1"></i> Start New Checklist
                                </a>
                            {% else %}
                                <p class="text-warning">Cannot create new checklist - another operator may have one active</p>
                                <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#workflowModal">
                                    <i class="fas fa-info-circle me-1"></i> Show Workflow
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Parameter Group Status Cards -->
    {% if active_checklist and parameter_group_stats.total_parameters > 0 %}
        {% for param_data in parameter_groups_need_filling %}
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card shadow-sm" style="background-color: #1a1a1a; color: #fff; border: 1px solid #333;">
                        <div class="card-header text-white" style="background-color: #990000;">
                            <h6 class="mb-0">{{ param_data.config.get_parameter_group_display }}</h6>
                        </div>
                        <div class="card-body">
                            <div class="single-row-content">
                                <!-- LEFT: Parameter Info -->
                                <div>
                                    <p class="mb-1">
                                        <i class="fas fa-clipboard-check me-1"></i>
                                        <strong>Frequency:</strong> Every {{ param_data.config.frequency_minutes }} minutes
                                    </p>
                                    <p class="mb-0 text-muted" style="font-size: 0.85rem;">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Filled {{ param_data.entry_count }} time{{ param_data.entry_count|pluralize }} 
                                        (Expected: {{ param_data.expected_fills }})
                                    </p>
                                </div>
                                
                                <!-- MIDDLE: Status -->
                                <div>
                                    {% if param_data.can_fill_now %}
                                        <span class="badge bg-success">Ready to Fill</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Next in {{ param_data.minutes_until_next }} min</span>
                                    {% endif %}
                                </div>
                                
                                <!-- RIGHT: Action Button -->
                                <div>
                                    {% if param_data.can_fill_now %}
                                        <a href="{% url 'fill_parameter_group' checklist_id=active_checklist.id %}" class="btn btn-danger btn-sm">
                                            <i class="fas fa-plus me-1"></i> Fill Parameter
                                        </a>
                                    {% else %}
                                        <button class="btn btn-outline-secondary btn-sm" disabled>
                                            <i class="fas fa-clock me-1"></i> Not Yet Available
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Quality Dashboard Cards -->
    <div class="row mb-3">
        <!-- Today's FTQ -->
        <div class="col-md-6">
            <div class="card h-100 shadow-sm" style="background-color: #1a1a1a; color: #fff; border: 1px solid #333;">
                <div class="card-header text-white" style="background-color: #990000;">
                    <h6 class="mb-0">Today's FTQ checksheet Record</h6>
                </div>
                <div class="card-body">
                    {% if today_ftq %}
                        <div class="compact-stats">
                            <div class="stat-item">
                                <p class="stat-value text-success">{{ today_ftq.total_inspected }}</p>
                                <p class="stat-label text-muted">Total Production</p>
                            </div>
                            <div class="stat-item">
                                <p class="stat-value text-warning">{{ today_ftq.total_defects }}</p>
                                <p class="stat-label text-muted">Total Defects</p>
                            </div>
                            <div class="stat-item">
                                <p class="stat-value text-info">{{ today_ftq.ftq_percentage }}%</p>
                                <p class="stat-label text-muted">FTQ %</p>
                            </div>
                        </div>
                        <div class="mt-2 text-center">
                            <a href="{% url 'ftq_record_detail' today_ftq.id %}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-eye me-1"></i> View Details
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <p class="text-danger mb-2">No FTQ record for today</p>
                            {% if active_verification %}
                                <a href="{% url 'ftq_record_create' %}" class="btn btn-danger btn-sm">
                                    <i class="fas fa-plus me-1"></i> Create FTQ Record
                                </a>
                            {% else %}
                                <p class="text-muted small">Create verification sheet first</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- EPVS Check Status -->
        <div class="col-md-6">
            <div class="card h-100 shadow-sm" style="background-color: #1a1a1a; color: #fff; border: 1px solid #333;">
                <div class="card-header text-white" style="background-color: #990000;">
                    <h6 class="mb-0">EPVS CheckSheet Status</h6>
                </div>
                <div class="card-body">
                    {% if today_ep_check %}
                        <div class="text-center py-3">
                            <div class="mb-2">
                                <i class="fas fa-shield-alt text-success" style="font-size: 2rem;"></i>
                            </div>
                            <p class="text-success mb-2">✓ Completed</p>
                            <p class="text-muted small">{{ today_ep_check.created_at|date:"H:i" }}</p>
                            <a href="{% url 'ep_check_detail' today_ep_check.id %}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-eye me-1"></i> View Details
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <div class="mb-2">
                                <i class="fas fa-shield-alt text-danger" style="font-size: 2rem;"></i>
                            </div>
                            <p class="text-danger mb-2">Not Completed</p>
                            {% if active_verification %}
                                <a href="{% url 'ep_check_create' %}" class="btn btn-danger btn-sm">
                                    <i class="fas fa-plus me-1"></i> Create EPVS Check
                                </a>
                            {% else %}
                                <p class="text-muted small">Create verification sheet first</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Available Checksheets - Individual Cards -->
    {% if active_checksheets %}
        {% for checksheet in active_checksheets %}
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="card shadow-sm" style="background-color: #1a1a1a; color: #fff; border: 1px solid #333;">
                        <div class="card-header text-white" style="background-color: #990000;">
                            <h6 class="mb-0">{{ checksheet.name }}</h6>
                        </div>
                        <div class="card-body">
                            <div class="single-row-content">
                                <!-- LEFT: Checksheet Info -->
                                <div>
                                    {% if checksheet.name_hindi %}
                                        <h6 class="text-warning mb-1">{{ checksheet.name_hindi }}</h6>
                                    {% endif %}
                                    <p class="mb-0 text-muted" style="font-size: 0.85rem;">
                                        <i class="fas fa-clipboard-list me-1"></i>
                                        {{ checksheet.total_sections }} section{{ checksheet.total_sections|pluralize }} • {{ checksheet.total_fields }} field{{ checksheet.total_fields|pluralize }}
                                    </p>
                                    {% if checksheet.description %}
                                        <p class="mb-0 text-muted small">{{ checksheet.description|truncatechars:60 }}</p>
                                    {% endif %}
                                </div>
                                
                                <!-- MIDDLE: Status -->
                                <div>
                                    {% comment %} Check if this checksheet was filled today {% endcomment %}
                                    {% if checksheet in checksheets_need_filling %}
                                        <span class="badge bg-warning text-dark">Needs Filling</span>
                                    {% else %}
                                        <span class="badge bg-success">Completed Today</span>
                                    {% endif %}
                                </div>
                                
                                <!-- RIGHT: Action Button -->
                                <div>
                                    {% if checksheet in checksheets_need_filling %}
                                        <a href="{% url 'create_checksheet_response' checksheet.id %}" class="btn btn-danger btn-sm">
                                            <i class="fas fa-plus me-1"></i> Fill Checksheet
                                        </a>
                                    {% else %}
                                        <a href="{% url 'checksheet_responses_list' %}" class="btn btn-outline-light btn-sm">
                                            <i class="fas fa-eye me-1"></i> View Response
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    <!-- DTPM Checklist Status -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card shadow-sm" style="background-color: #1a1a1a; color: #fff; border: 1px solid #333;">
                <div class="card-header text-white" style="background-color: #990000;">
                    <h6 class="mb-0">Daily TPM CheckSheet  Status</h6>
                </div>
                <div class="card-body">
                    {% if today_dtpm_checklist %}
                        <div class="single-row-content">
                            <div>
                                <h6 class="text-success mb-1">✓ Completed</h6>
                                <p class="mb-0 text-muted">{{ today_dtpm_checklist.created_at|date:"H:i" }}</p>
                            </div>
                            <div>
                                <span class="badge bg-success">Daily Tracking Complete</span>
                            </div>
                            <div>
                                <a href="{% url 'dtpm_new_detail' today_dtpm_checklist.id %}" class="btn btn-outline-light btn-sm">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="single-row-content">
                            <div>
                                <h6 class="text-danger mb-1">Not Completed</h6>
                                <p class="mb-0 text-muted">Daily tracking pending</p>
                            </div>
                            <div>
                                <span class="badge bg-danger">Action Required</span>
                            </div>
                            <div>
                                {% if active_verification %}
                                    <a href="{% url 'dtpm_checklist_create' %}" class="btn btn-danger btn-sm">
                                        <i class="fas fa-plus me-1"></i> Create DTPM Checklist
                                    </a>
                                {% else %}
                                    <span class="text-muted small">Create verification sheet first</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card shadow-sm" style="background-color: #1a1a1a; color: #fff; border: 1px solid #333;">
                <div class="card-header text-white" style="background-color: #990000;">
                    <h6 class="mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#workflowModal">
                            <i class="fas fa-info-circle me-1"></i> Show Workflow
                        </button>
                        
                        {% if active_verification %}
                            {% if not today_ftq %}
                                <a href="{% url 'ftq_record_create' %}" class="btn btn-danger btn-sm pulse-button">
                                    <i class="fas fa-plus me-1"></i> Create FTQ Record
                                </a>
                            {% endif %}
                            
                            {% if not today_ep_check %}
                                <a href="{% url 'ep_check_create' %}" class="btn btn-warning btn-sm pulse-button">
                                    <i class="fas fa-shield-alt me-1"></i> Create EPVS Check
                                </a>
                            {% endif %}
                            
                            {% if not today_dtpm_checklist %}
                                <a href="{% url 'dtpm_checklist_create' %}" class="btn btn-info btn-sm pulse-button">
                                    <i class="fas fa-clipboard-check me-1"></i> Create DTPM Checklist
                                </a>
                            {% endif %}
                            
                            {% comment %} Add parameter group action buttons {% endcomment %}
                            {% if parameter_groups_need_filling %}
                                <a href="{% url 'fill_parameter_group' checklist_id=active_checklist.id %}" class="btn btn-success btn-sm pulse-button">
                                    <i class="fas fa-vial me-1"></i> Fill Parameters ({{ parameter_group_stats.ready_count }} ready)
                                </a>
                            {% endif %}
                            
                            {% comment %} Add checksheet action buttons {% endcomment %}
                            {% if checksheets_need_filling %}
                                {% for checksheet in checksheets_need_filling %}
                                    <a href="{% url 'create_checksheet_response' checksheet.id %}" class="btn btn-success btn-sm pulse-button">
                                        <i class="fas fa-clipboard-list me-1"></i> Fill {{ checksheet.name|truncatechars:15 }}
                                    </a>
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                        
                        <a href="{% url 'checksheet_list' %}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-clipboard-list me-1"></i> All Checksheets
                        </a>
                        
                        <a href="{% url 'checksheet_responses_list' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-file-alt me-1"></i> My Responses
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Modal -->
<div class="modal fade" id="workflowModal" tabindex="-1" aria-labelledby="workflowModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: #1a1a1a; color: #fff;">
            <div class="modal-header" style="background-color: #990000; border-bottom: 1px solid #333;">
                <h5 class="modal-title text-white" id="workflowModalLabel">Daily Workflow Guide</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Follow these steps in order to complete your daily quality checks:</p>
                <ol class="list-group list-group-numbered">
                    <li class="list-group-item d-flex justify-content-between align-items-start {% if not active_verification %}bg-danger text-white{% else %}bg-dark text-white{% endif %} border-danger">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">Step 1: Create Daily Verification Sheet</div>
                            Start your shift by creating the main verification document
                            {% if not active_verification %}
                            <div class="mt-1"><i class="fas fa-exclamation-circle me-1"></i> <strong>Start Here</strong></div>
                            {% endif %}
                        </div>
                        {% if active_verification %}
                        <span class="badge bg-success rounded-pill">Complete</span>
                        {% else %}
                        <span class="badge bg-danger rounded-pill">Start Here</span>
                        {% endif %}
                    </li>
                    
                    {% comment %} Parameter Groups Steps {% endcomment %}
                    {% if parameter_group_stats.total_parameters > 0 %}
                        <li class="list-group-item d-flex justify-content-between align-items-start {% if active_verification and parameter_group_stats.ready_count > 0 %}bg-danger text-white{% else %}bg-dark text-white{% endif %} border-danger">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">Step 2: Fill Parameter Groups</div>
                                Complete all required parameter measurements throughout the shift
                                <ul class="mt-2 mb-0">
                                    <li>UV Vacuum Test (5 readings)</li>
                                    <li>UV Flow Value (5 readings)</li>
                                    <li>Umbrella Valve Assembly (5 checks)</li>
                                    <li>UV Clip Pressing (5 checks)</li>
                                    <li>Workstation Clean (1 check)</li>
                                    <li>Bin Contamination Check (5 checks)</li>
                                </ul>
                                {% if active_verification and parameter_group_stats.ready_count > 0 %}
                                <div class="mt-1"><i class="fas fa-exclamation-circle me-1"></i> <strong>{{ parameter_group_stats.ready_count }} parameter(s) ready to fill</strong></div>
                                {% endif %}
                            </div>
                            {% if parameter_group_stats.filled_count > 0 %}
                            <span class="badge bg-warning rounded-pill">In Progress ({{ parameter_group_stats.filled_count }}/{{ parameter_group_stats.total_parameters }})</span>
                            {% elif active_verification %}
                            <span class="badge bg-danger rounded-pill">Action Required</span>
                            {% else %}
                            <span class="badge bg-secondary rounded-pill">Not Ready</span>
                            {% endif %}
                        </li>
                    {% endif %}
                    
                    <li class="list-group-item d-flex justify-content-between align-items-start {% if active_verification and not today_ep_check %}bg-danger text-white{% else %}bg-dark text-white{% endif %} border-danger">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">Step 3: EPVS Checksheet</div>
                            Verify all error prevention mechanisms are working
                            {% if active_verification and not today_ep_check %}
                            <div class="mt-1"><i class="fas fa-exclamation-circle me-1"></i> <strong>Action Required</strong></div>
                            {% endif %}
                        </div>
                        {% if today_ep_check %}
                        <span class="badge bg-success rounded-pill">Complete</span>
                        {% elif active_verification %}
                        <span class="badge bg-danger rounded-pill">Action Required</span>
                        {% else %}
                        <span class="badge bg-secondary rounded-pill">Not Ready</span>
                        {% endif %}
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-start {% if active_verification and not today_dtpm_checklist %}bg-danger text-white{% else %}bg-dark text-white{% endif %} border-danger">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">Step 4: DTPM Checklist</div>
                            Daily Tracking & Performance Monitoring tasks
                            {% if active_verification and not today_dtpm_checklist %}
                            <div class="mt-1"><i class="fas fa-exclamation-circle me-1"></i> <strong>Action Required</strong></div>
                            {% endif %}
                        </div>
                        {% if today_dtpm_checklist %}
                        <span class="badge bg-success rounded-pill">Complete</span>
                        {% elif active_verification %}
                        <span class="badge bg-danger rounded-pill">Action Required</span>
                        {% else %}
                        <span class="badge bg-secondary rounded-pill">Not Ready</span>
                        {% endif %}
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-start {% if active_verification and not today_ftq %}bg-danger text-white{% else %}bg-dark text-white{% endif %} border-danger">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">Step 5: FTQ Record</div>
                            Create quality record with production and defect information
                            {% if active_verification and not today_ftq %}
                            <div class="mt-1"><i class="fas fa-exclamation-circle me-1"></i> <strong>Action Required</strong></div>
                            {% endif %}
                        </div>
                        {% if today_ftq %}
                        <span class="badge bg-success rounded-pill">Complete</span>
                        {% elif active_verification %}
                        <span class="badge bg-danger rounded-pill">Action Required</span>
                        {% else %}
                        <span class="badge bg-secondary rounded-pill">Not Ready</span>
                        {% endif %}
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-start bg-dark text-white border-danger">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">Step 6: Supervisor Verification</div>
                            Wait for supervisor to verify your entries
                        </div>
                        {% if active_verification and active_verification.status == 'supervisor_approved' %}
                        <span class="badge bg-success rounded-pill">Complete</span>
                        {% elif active_verification %}
                        <span class="badge bg-secondary rounded-pill">Pending</span>
                        {% else %}
                        <span class="badge bg-secondary rounded-pill">Not Ready</span>
                        {% endif %}
                    </li>
                </ol>                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> You can create FTQ, EPVS Check, and DTPM Checklists as soon as you've created the Daily Verification Sheet. Parameter groups will become available throughout the shift based on their frequency settings.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
                {% if not active_verification %}
                    {% if can_create_new %}
                    <a href="{% url 'create_checklist' %}" class="btn btn-danger">
                        <i class="fas fa-plus me-1"></i> Start Verification Sheet
                    </a>
                    {% endif %}
                {% elif parameter_groups_need_filling %}
                <a href="{% url 'fill_parameter_group' checklist_id=active_checklist.id %}" class="btn btn-success me-2">
                    <i class="fas fa-vial me-1"></i> Fill Parameters
                </a>
                {% elif active_verification and not today_ep_check %}
                <a href="{% url 'ep_check_create' %}" class="btn btn-danger me-2">
                    <i class="fas fa-shield-alt me-1"></i> Create EPVS Check
                </a>
                {% elif active_verification and not today_dtpm_checklist %}
                <a href="{% url 'dtpm_checklist_create' %}" class="btn btn-danger me-2">
                    <i class="fas fa-clipboard-check me-1"></i> Create DTPM Checklist
                </a>
                {% elif active_verification and not today_ftq %}
                <a href="{% url 'ftq_record_create' %}" class="btn btn-danger">
                    <i class="fas fa-plus me-1"></i> Create FTQ Record
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Show workflow modal on page load if active checklist exists and any required records are missing
    document.addEventListener('DOMContentLoaded', function() {
        {% if active_verification %}
            {% if not today_ftq or not today_ep_check or not today_dtpm_checklist or parameter_group_stats.ready_count > 0 %}
                // Show modal automatically when verification exists but any required records are missing
                const workflowModal = new bootstrap.Modal(document.getElementById('workflowModal'));
                workflowModal.show();
            {% endif %}
        {% endif %}
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    // Update current time every second
    function updateTime() {
        const timeElement = document.getElementById('currentTime');
        const now = new Date();
        timeElement.textContent = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
        });
    }
    
    setInterval(updateTime, 1000);
</script>
{% endblock %}