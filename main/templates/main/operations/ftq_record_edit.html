{% extends "main/base.html" %}
{% load static %}

{% block title %}Edit FTQ Record{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        background-color: #111111;
        border: 2px solid #ffffff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .card-title { color: #ff0000; font-weight: 600; margin-bottom: 15px; }
    .form-label { color: #ffffff; font-weight: 500; }
    .form-control, .form-select {
        background-color: #111111;
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .form-control:focus, .form-select:focus {
        background-color: #111111;
        color: #ffffff;
        border-color: #ff0000;
    }
    
    .defect-time-table {
        width: 100%;
        color: #ffffff;
    }
    .defect-time-table thead th {
        background-color: rgba(255, 0, 0, 0.2);
        padding: 12px 8px;
        border-bottom: 2px solid #ff0000;
    }
    .defect-time-table tbody tr:nth-child(odd) { background-color: rgba(255, 255, 255, 0.05); }
    .defect-time-table td { padding: 8px; }
    
    .time-entry-group {
        display: flex;
        gap: 5px;
        align-items: center;
        margin-bottom: 5px;
    }
    .time-input {
        width: 80px;
        background-color: #222;
        color: #fff;
        border: 1px solid #fff;
        border-radius: 4px;
        padding: 4px 8px;
    }
    .count-input {
        width: 60px;
        background-color: #222;
        color: #fff;
        border: 1px solid #fff;
        border-radius: 4px;
        padding: 4px 8px;
    }
    .btn-add-time, .btn-remove-time {
        background-color: transparent;
        border: 1px solid #28a745;
        color: #28a745;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .btn-remove-time { border-color: #dc3545; color: #dc3545; }
    .defect-total { font-weight: bold; color: #ff0000; text-align: center; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white"><i class="fas fa-edit me-2"></i>Edit FTQ Record</h2>
        <div>
            <a href="{% url 'ftq_record_detail' pk=ftq_record.id %}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-1"></i> Back to Detail
            </a>
            <a href="{% url 'ftq_list' %}" class="btn btn-outline-light ms-2">
                <i class="fas fa-list me-1"></i> All Records
            </a>
        </div>
    </div>
    
    <form method="post" id="ftqForm">
        {% csrf_token %}
        
        <div class="form-card">
            <h5 class="card-title">Record Information</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Date</label>
                    {{ form.date }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Shift</label>
                    {{ form.shift_type }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Model</label>
                    {{ form.model_name }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Julian Date</label>
                    {{ form.julian_date }}
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Production/Day</label>
                    {{ form.total_inspected }}
                </div>
            </div>
        </div>
        
        <div class="form-card">
            <h5 class="card-title">Time-Based Defect Tracking</h5>
            <p class="text-muted small">Update defects with time throughout the shift</p>
            
            <div class="table-responsive">
                <table class="defect-time-table">
                    <thead>
                        <tr>
                            <th width="5%">S.No.</th>
                            <th width="40%">Defect Type</th>
                            <th width="45%">Time & Count Entries</th>
                            <th width="10%">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for defect in default_defects %}
                        <tr>
                            <td class="text-center">{{ forloop.counter }}</td>
                            <td>{{ defect.name }}</td>
                            <td>
                                <div id="time-entries-{{ defect.id }}" data-defect-id="{{ defect.id }}" 
                                     data-entries='{{ defect.entries_json|safe }}'>
                                    <!-- Entries will be populated by JavaScript -->
                                </div>
                            </td>
                            <td class="defect-total" id="total-{{ defect.id }}">0</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="form-card">
            <h5 class="card-title">Custom Defects</h5>
            <div id="customDefectsContainer">
                {% for custom in existing_custom_defects %}
                <div class="form-card" data-custom-id="{{ custom.id }}">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-white mb-0">{{ custom.name }}</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="this.closest('.form-card').remove()">
                            <i class="fas fa-trash me-1"></i> Remove
                        </button>
                    </div>
                    <div id="time-entries-custom_{{ custom.id }}" data-defect-id="custom_{{ custom.id }}"
                         data-entries='{{ custom.entries_json|safe }}'>
                        <!-- Entries will be populated by JavaScript -->
                    </div>
                    <input type="hidden" name="custom_defect_name_custom_{{ custom.id }}" value="{{ custom.name }}">
                    <div class="mt-2">Total: <span class="defect-total" id="total-custom_{{ custom.id }}">0</span></div>
                </div>
                {% endfor %}
            </div>
            <div class="text-center mt-3">
                <button type="button" class="btn btn-outline-light" onclick="addCustomDefect()">
                    <i class="fas fa-plus me-1"></i> Add Custom Defect
                </button>
            </div>
        </div>
        
        <div class="text-center mt-4 mb-5">
            <button type="submit" class="btn btn-danger px-5">
                <i class="fas fa-save me-1"></i> Update Record
            </button>
            <a href="{% url 'ftq_record_detail' pk=ftq_record.id %}" class="btn btn-outline-light ms-3">
                <i class="fas fa-times me-1"></i> Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let timeEntryCounters = {};
let customDefectCounter = 0;

// Populate existing entries on page load
document.addEventListener('DOMContentLoaded', function() {
    // Populate standard defects
    document.querySelectorAll('[id^="time-entries-"][data-entries]').forEach(container => {
        const defectId = container.getAttribute('data-defect-id');
        const entriesJson = container.getAttribute('data-entries');
        
        if (entriesJson && entriesJson !== '[]') {
            const entries = JSON.parse(entriesJson);
            container.innerHTML = ''; // Clear container
            
            entries.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'time-entry-group';
                entryDiv.innerHTML = `
                    <input type="time" class="time-input" 
                           name="defect_time_${defectId}_${index}"
                           value="${entry.time}">
                    <input type="number" class="count-input defect-count" 
                           name="defect_count_${defectId}_${index}" 
                           min="0" value="${entry.count}" 
                           data-defect-id="${defectId}">
                    ${index === 0 ? `
                    <button type="button" class="btn-add-time" 
                            onclick="addTimeEntry('${defectId}')">
                        <i class="fas fa-plus"></i>
                    </button>` : `
                    <button type="button" class="btn-remove-time" 
                            onclick="removeTimeEntry(this, '${defectId}')">
                        <i class="fas fa-trash"></i>
                    </button>`}
                `;
                container.appendChild(entryDiv);
            });
            
            timeEntryCounters[defectId] = entries.length;
        } else {
            // No existing entries, add default empty one
            addDefaultEntry(container, defectId);
        }
        
        // Add event listeners
        container.querySelectorAll('.defect-count').forEach(input => {
            input.addEventListener('input', function() {
                updateDefectTotal(defectId);
            });
        });
        
        updateDefectTotal(defectId);
    });
});

function addDefaultEntry(container, defectId) {
    container.innerHTML = `
        <div class="time-entry-group">
            <input type="time" class="time-input" name="defect_time_${defectId}_0">
            <input type="number" class="count-input defect-count" 
                   name="defect_count_${defectId}_0" 
                   min="0" value="0" data-defect-id="${defectId}">
            <button type="button" class="btn-add-time" 
                    onclick="addTimeEntry('${defectId}')">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    `;
    timeEntryCounters[defectId] = 1;
}

function addTimeEntry(defectId) {
    const container = document.getElementById(`time-entries-${defectId}`);
    const index = timeEntryCounters[defectId] || 0;
    
    const entryDiv = document.createElement('div');
    entryDiv.className = 'time-entry-group';
    entryDiv.innerHTML = `
        <input type="time" class="time-input" name="defect_time_${defectId}_${index}">
        <input type="number" class="count-input defect-count" 
               name="defect_count_${defectId}_${index}" 
               min="0" value="0" data-defect-id="${defectId}">
        <button type="button" class="btn-remove-time" 
                onclick="removeTimeEntry(this, '${defectId}')">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(entryDiv);
    timeEntryCounters[defectId] = index + 1;
    
    entryDiv.querySelector('.defect-count').addEventListener('input', function() {
        updateDefectTotal(defectId);
    });
}

function removeTimeEntry(button, defectId) {
    button.closest('.time-entry-group').remove();
    updateDefectTotal(defectId);
}

function updateDefectTotal(defectId) {
    const counts = document.querySelectorAll(`.defect-count[data-defect-id="${defectId}"]`);
    let total = 0;
    counts.forEach(input => { total += parseInt(input.value) || 0; });
    const totalEl = document.getElementById(`total-${defectId}`);
    if (totalEl) totalEl.textContent = total;
}

function addCustomDefect() {
    const container = document.getElementById('customDefectsContainer');
    const customId = `custom_${customDefectCounter}`;
    
    const defectDiv = document.createElement('div');
    defectDiv.className = 'form-card';
    defectDiv.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Custom Defect Name</label>
                <input type="text" class="form-control" 
                       name="custom_defect_name_${customId}" required>
            </div>
            <div class="col-md-6">
                <button type="button" class="btn btn-outline-danger" 
                        onclick="this.closest('.form-card').remove()">
                    <i class="fas fa-trash me-1"></i> Remove
                </button>
            </div>
        </div>
        <div id="time-entries-${customId}">
            <div class="time-entry-group">
                <input type="time" class="time-input" name="defect_time_${customId}_0">
                <input type="number" class="count-input defect-count" 
                       name="defect_count_${customId}_0" 
                       min="0" value="0" data-defect-id="${customId}">
                <button type="button" class="btn-add-time" 
                        onclick="addTimeEntry('${customId}')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="mt-2">Total: <span class="defect-total" id="total-${customId}">0</span></div>
    `;
    
    container.appendChild(defectDiv);
    timeEntryCounters[customId] = 1;
    customDefectCounter++;
    
    defectDiv.querySelector('.defect-count').addEventListener('input', function() {
        updateDefectTotal(customId);
    });
}
</script>
{% endblock %}