{% extends "main/base.html" %}
{% load static %}

{% block title %}Create FTQ Record{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        background-color: #111111;
        border: 2px solid #ffffff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .card-title { color: #ff0000; font-weight: 600; margin-bottom: 15px; }
    .form-label { color: #ffffff; font-weight: 500; }
    .form-control, .form-select {
        background-color: #111111;
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .form-control:focus, .form-select:focus {
        background-color: #111111;
        color: #ffffff;
        border-color: #ff0000;
    }
    
    .defect-time-table {
        width: 100%;
        color: #ffffff;
    }
    .defect-time-table thead th {
        background-color: rgba(255, 0, 0, 0.2);
        padding: 12px 8px;
        border-bottom: 2px solid #ff0000;
    }
    .defect-time-table tbody tr:nth-child(odd) { background-color: rgba(255, 255, 255, 0.05); }
    .defect-time-table td { padding: 8px; }
    
    .time-entry-group {
        display: flex;
        gap: 5px;
        align-items: center;
        margin-bottom: 5px;
    }
    .time-input {
        width: 80px;
        background-color: #222;
        color: #fff;
        border: 1px solid #fff;
        border-radius: 4px;
        padding: 4px 8px;
    }
    .count-input {
        width: 60px;
        background-color: #222;
        color: #fff;
        border: 1px solid #fff;
        border-radius: 4px;
        padding: 4px 8px;
    }
    .btn-add-time, .btn-remove-time {
        background-color: transparent;
        border: 1px solid #28a745;
        color: #28a745;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .btn-remove-time { border-color: #dc3545; color: #dc3545; }
    .defect-total { font-weight: bold; color: #ff0000; text-align: center; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-white"><i class="fas fa-plus-circle me-2"></i>Create FTQ Record</h2>
        <a href="{% url 'ftq_list' %}" class="btn btn-outline-light">
            <i class="fas fa-arrow-left me-1"></i> Back
        </a>
    </div>
    
    {% if active_checklist %}
    <div class="form-card">
        <h5 class="card-title">Active Verification Information</h5>
        <div class="row">
            <div class="col-md-2"><strong>Date:</strong> {{ active_verification.date }}</div>
            <div class="col-md-2"><strong>Shift:</strong> {{ active_verification.shift.get_shift_type_display }}</div>
            <div class="col-md-2"><strong>Model:</strong> {{ active_checklist.get_selected_model_display }}</div>
            <div class="col-md-3"><strong>Operator:</strong> {{ active_verification.created_by.username }}</div>
        </div>
    </div>
    {% endif %}
    
    <form method="post" id="ftqForm">
        {% csrf_token %}
        
        <div class="form-card">
            <h5 class="card-title">Record Information</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Date</label>
                    {{ form.date }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Shift</label>
                    {{ form.shift_type }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Model</label>
                    {{ form.model_name }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">Julian Date</label>
                    {{ form.julian_date }}
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Production/Day</label>
                    {{ form.total_inspected }}
                </div>
            </div>
        </div>
        
        <div class="form-card">
            <h5 class="card-title">Time-Based Defect Tracking</h5>
            <p class="text-muted small">Record defects with time throughout the shift</p>
            
            <div class="table-responsive">
                <table class="defect-time-table">
                    <thead>
                        <tr>
                            <th width="5%">S.No.</th>
                            <th width="40%">Defect Type</th>
                            <th width="45%">Time & Count Entries</th>
                            <th width="10%">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for defect in default_defects %}
                        <tr>
                            <td class="text-center">{{ forloop.counter }}</td>
                            <td>{{ defect.name }}</td>
                            <td>
                                <div id="time-entries-{{ defect.id }}">
                                    <div class="time-entry-group">
                                        <input type="time" class="time-input" 
                                               name="defect_time_{{ defect.id }}_0">
                                        <input type="number" class="count-input defect-count" 
                                               name="defect_count_{{ defect.id }}_0" 
                                               min="0" value="0" 
                                               data-defect-id="{{ defect.id }}">
                                        <button type="button" class="btn-add-time" 
                                                onclick="addTimeEntry({{ defect.id }})">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td class="defect-total" id="total-{{ defect.id }}">0</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="form-card">
            <h5 class="card-title">Custom Defects</h5>
            <div id="customDefectsContainer"></div>
            <div class="text-center mt-3">
                <button type="button" class="btn btn-outline-light" onclick="addCustomDefect()">
                    <i class="fas fa-plus me-1"></i> Add Custom Defect
                </button>
            </div>
        </div>
        
        <div class="text-center mt-4 mb-5">
            <button type="submit" class="btn btn-danger px-5">
                <i class="fas fa-save me-1"></i> Save Record
            </button>
            <a href="{% url 'ftq_list' %}" class="btn btn-outline-light ms-3">
                <i class="fas fa-times me-1"></i> Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let timeEntryCounters = {};
let customDefectCounter = 0;

document.querySelectorAll('[data-defect-id]').forEach(row => {
    const defectId = row.getAttribute('data-defect-id');
    timeEntryCounters[defectId] = 1;
});

function addTimeEntry(defectId) {
    const container = document.getElementById(`time-entries-${defectId}`);
    const index = timeEntryCounters[defectId];
    
    const entryDiv = document.createElement('div');
    entryDiv.className = 'time-entry-group';
    entryDiv.innerHTML = `
        <input type="time" class="time-input" name="defect_time_${defectId}_${index}">
        <input type="number" class="count-input defect-count" 
               name="defect_count_${defectId}_${index}" 
               min="0" value="0" data-defect-id="${defectId}">
        <button type="button" class="btn-remove-time" 
                onclick="removeTimeEntry(this, ${defectId})">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(entryDiv);
    timeEntryCounters[defectId]++;
    
    entryDiv.querySelector('.defect-count').addEventListener('input', function() {
        updateDefectTotal(defectId);
    });
}

function removeTimeEntry(button, defectId) {
    button.closest('.time-entry-group').remove();
    updateDefectTotal(defectId);
}

function updateDefectTotal(defectId) {
    const counts = document.querySelectorAll(`.defect-count[data-defect-id="${defectId}"]`);
    let total = 0;
    counts.forEach(input => { total += parseInt(input.value) || 0; });
    document.getElementById(`total-${defectId}`).textContent = total;
}

function addCustomDefect() {
    const container = document.getElementById('customDefectsContainer');
    const customId = `custom_${customDefectCounter}`;
    
    const defectDiv = document.createElement('div');
    defectDiv.className = 'form-card';
    defectDiv.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Custom Defect Name</label>
                <input type="text" class="form-control" 
                       name="custom_defect_name_${customId}" required>
            </div>
            <div class="col-md-6">
                <button type="button" class="btn btn-outline-danger" 
                        onclick="this.closest('.form-card').remove()">
                    <i class="fas fa-trash me-1"></i> Remove
                </button>
            </div>
        </div>
        <div id="time-entries-${customId}">
            <div class="time-entry-group">
                <input type="time" class="time-input" name="defect_time_${customId}_0">
                <input type="number" class="count-input defect-count" 
                       name="defect_count_${customId}_0" 
                       min="0" value="0" data-defect-id="${customId}">
                <button type="button" class="btn-add-time" 
                        onclick="addTimeEntry('${customId}')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="mt-2">Total: <span class="defect-total" id="total-${customId}">0</span></div>
    `;
    
    container.appendChild(defectDiv);
    timeEntryCounters[customId] = 1;
    customDefectCounter++;
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.defect-count').forEach(input => {
        input.addEventListener('input', function() {
            updateDefectTotal(this.getAttribute('data-defect-id'));
        });
    });
});
</script>
{% endblock %}