{% extends 'main/base.html' %}
{% load static %}

{% block title %}Edit DTPM Checklist{% endblock %}

{% block extra_css %}
<style>
    .checkpoint-card {
        background-color: #1a1a1a;
        border: 1px solid #333;
        border-radius: 10px;
        margin-bottom: 30px;
        transition: all 0.3s;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .checkpoint-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(255, 0, 0, 0.3);
    }
    .checkpoint-header {
        background-color: #222;
        padding: 15px;
        border-radius: 10px 10px 0 0;
        border-bottom: 1px solid #444;
    }
    .checkpoint-number {
        background-color: #CC0000;
        color: white;
        padding: 4px 10px;
        border-radius: 50%;
        margin-right: 10px;
        font-weight: bold;
    }
    .hindi-text {
        color: #CCC;
        font-style: italic;
        margin-top: 5px;
        font-size: 0.9rem;
    }
    .status-select {
        border: 2px solid #555;
        padding: 10px;
        border-radius: 5px;
        background-color: #333;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }
    .status-select:focus {
        border-color: #CC0000;
        box-shadow: 0 0 0 0.25rem rgba(204, 0, 0, 0.25);
    }
    .status-ok {
        background-color: #28a745;
        color: white;
    }
    .status-ng {
        background-color: #dc3545;
        color: white;
    }
    .reference-image {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        border: 2px solid #555;
        transition: transform 0.3s;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }
    .reference-image:hover {
        transform: scale(1.02);
    }
    .reference-image-container {
        text-align: center;
        margin: 15px 0;
    }
    .status-container {
        background-color: #333;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .status-label {
        font-weight: bold;
        color: #CCC;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    .page-title {
        color: #CC0000;
        border-bottom: 2px solid #CC0000;
        padding-bottom: 10px;
        margin-bottom: 30px;
    }
    .comments-textarea {
        background-color: #333;
        border: 1px solid #555;
        color: white;
        border-radius: 5px;
        padding: 10px;
        resize: vertical;
        min-height: 80px;
    }
    .comments-textarea:focus {
        border-color: #CC0000;
        box-shadow: 0 0 0 0.25rem rgba(204, 0, 0, 0.25);
    }
    .edit-info-card {
        background-color: #222;
        border: 1px solid #444;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .edit-info-header {
        background-color: #333;
        border-bottom: 1px solid #444;
        padding: 15px;
        border-radius: 10px 10px 0 0;
    }
    .changed-indicator {
        background-color: #ffc107;
        color: #000;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-left: 10px;
    }
    .no-image-placeholder {
        background-color: #2a2a2a;
        border: 2px dashed #555;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        color: #999;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="page-title">
            <i class="fas fa-edit me-2"></i> 
            Edit DTPM Checklist - {{ checklist.date }}
        </h2>
    </div>
</div>

<!-- Checklist Info Card -->
<div class="edit-info-card">
    <div class="edit-info-header">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Checklist Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <p><span class="text-muted">Date:</span> <span class="text-white">{{ checklist.date }}</span></p>
            </div>
            <div class="col-md-3">
                <p><span class="text-muted">Shift:</span> <span class="text-white">{{ checklist.get_checklist_shift_display }}</span></p>
            </div>
            <div class="col-md-3">
                <p><span class="text-muted">Operator:</span> <span class="text-white">{{ checklist.operator.username }}</span></p>
            </div>
            <div class="col-md-3">
                <p><span class="text-muted">Model:</span> <span class="text-white">{{ checklist.current_model }}</span></p>
            </div>
        </div>
    </div>
</div>

<form method="post">
    {% csrf_token %}
    
    {% for check_result in checkpoint_results %}
    <div class="checkpoint-card">
        <div class="checkpoint-header">
            <h5>
                <span class="checkpoint-number">{{ check_result.checkpoint.checkpoint_number }}</span>
                {{ check_result.checkpoint.title_english }}
            </h5>
            {% if check_result.checkpoint.title_hindi %}
            <div class="hindi-text">{{ check_result.checkpoint.title_hindi }}</div>
            {% endif %}
            {% if check_result.checkpoint.description %}
            <small class="text-muted d-block mt-2">{{ check_result.checkpoint.description }}</small>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="reference-image-container">
                        {% if check_result.checkpoint.reference_image and check_result.checkpoint.reference_image.name %}
                        <img src="{{ check_result.checkpoint.reference_image.url }}" 
                             alt="Reference Image for {{ check_result.checkpoint.title_english }}" 
                             class="reference-image">
                        {% else %}
                        <div class="no-image-placeholder">
                            <i class="fas fa-image fa-3x mb-2"></i>
                            <p>No reference image available</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="status-container">
                        <div class="status-label">
                            Status / स्थिति:
                            {% if check_result.updated_at != check_result.checked_at %}
                                <span class="changed-indicator">MODIFIED</span>
                            {% endif %}
                        </div>
                        <select name="status_{{ check_result.checkpoint.id }}" 
                                id="status_{{ check_result.checkpoint.id }}" 
                                class="form-select status-select {% if check_result.status == 'OK' %}status-ok{% elif check_result.status == 'NG' %}status-ng{% endif %}"
                                data-original-value="{{ check_result.status }}">
                            <option value="">-- Select Status --</option>
                            <option value="OK" class="status-ok" {% if check_result.status == 'OK' %}selected{% endif %}>OK ✓</option>
                            <option value="NG" class="status-ng" {% if check_result.status == 'NG' %}selected{% endif %}>NG ✗</option>
                        </select>
                        
                        <div class="mt-3">
                            <label class="status-label" for="comments_{{ check_result.checkpoint.id }}">
                                Comments / टिप्पणियाँ:
                            </label>
                            <textarea name="comments_{{ check_result.checkpoint.id }}" 
                                    id="comments_{{ check_result.checkpoint.id }}"
                                    class="form-control comments-textarea"
                                    placeholder="Enter any comments or observations..."
                                    data-original-value="{{ check_result.comments|default:'' }}">{{ check_result.comments }}</textarea>
                        </div>
                        
                        {% if check_result.updated_at != check_result.checked_at %}
                        <div class="mt-2">
                            <small class="text-warning">
                                <i class="fas fa-clock"></i> Last updated: {{ check_result.updated_at|date:"M d, Y H:i" }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <div class="text-end mt-4 mb-5">
        <a href="{% url 'dtpm_new_detail' pk=checklist.id %}" class="btn btn-secondary me-2">
            <i class="fas fa-times"></i> Cancel
        </a>
        <button type="submit" class="btn btn-warning btn-lg" id="saveBtn">
            <i class="fas fa-save"></i> Update Checklist
        </button>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelects = document.querySelectorAll('.status-select');
    const textareas = document.querySelectorAll('.comments-textarea');
    const saveBtn = document.getElementById('saveBtn');
    let hasChanges = false;

    function checkForChanges() {
        hasChanges = false;
        
        statusSelects.forEach(select => {
            if (select.value !== select.dataset.originalValue) {
                hasChanges = true;
            }
        });
        
        textareas.forEach(textarea => {
            const originalValue = textarea.dataset.originalValue || '';
            if (textarea.value !== originalValue) {
                hasChanges = true;
            }
        });
        
        if (hasChanges) {
            saveBtn.classList.remove('btn-warning');
            saveBtn.classList.add('btn-success');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        } else {
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-warning');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Checklist';
        }
    }

    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            this.classList.remove('status-ok', 'status-ng');
            
            if (this.value === 'OK') {
                this.classList.add('status-ok');
            } else if (this.value === 'NG') {
                this.classList.add('status-ng');
            }
            
            checkForChanges();
        });
    });

    textareas.forEach(textarea => {
        textarea.addEventListener('input', checkForChanges);
    });

    window.addEventListener('beforeunload', function(e) {
        if (hasChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    document.querySelector('form').addEventListener('submit', function() {
        window.removeEventListener('beforeunload', arguments.callee);
    });
});
</script>
{% endblock %}