{% extends 'main/base.html' %}
{% load checksheet_filters %}

{% block page_icon %}fas fa-edit{% endblock %}

{% block content %}
<form method="post" id="checksheetForm">
    {% csrf_token %}
    
    {% for section in sections %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">{{ section.name }}</h5>
            {% if section.description %}
                <small class="text-white-50">{{ section.description }}</small>
            {% endif %}
        </div>
        <div class="card-body">
            {% for field in section.fields.all %}
                <div class="row mb-3 field-row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            {{ field.label }}
                            {% if field.is_required %}<span class="text-danger">*</span>{% endif %}
                            {% if field.unit %}
                                <span class="text-muted">({{ field.unit }})</span>
                            {% endif %}
                        </label>
                        {% if field.help_text %}
                            <small class="text-muted d-block">{{ field.help_text }}</small>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-8">
                        <!-- TEXT INPUT -->
                        {% if field.field_type == 'text' %}
                            <input type="text" 
                                   class="form-control" 
                                   name="field_{{ field.id }}"
                                   placeholder="{{ field.placeholder }}"
                                   {% if field.is_required %}required{% endif %}
                                   value="{% if is_edit and field.id in field_responses %}{{ field_responses|get_item:field.id|get_item:'value' }}{% elif form_data %}{{ form_data|get_field_value:field.id }}{% else %}{{ field.default_value }}{% endif %}">
                        
                        <!-- NUMBER INPUT -->
                        {% elif field.field_type == 'number' %}
                            <input type="number" 
                                   class="form-control" 
                                   name="field_{{ field.id }}"
                                   {% if field.min_value %}min="{{ field.min_value }}"{% endif %}
                                   {% if field.max_value %}max="{{ field.max_value }}"{% endif %}
                                   step="1"
                                   placeholder="{{ field.placeholder }}"
                                   {% if field.is_required %}required{% endif %}
                                   value="{% if is_edit and field.id in field_responses %}{{ field_responses|get_item:field.id|get_item:'value' }}{% elif form_data %}{{ form_data|get_field_value:field.id }}{% else %}{{ field.default_value }}{% endif %}">
                        
                        <!-- DECIMAL INPUT -->
                        {% elif field.field_type == 'decimal' %}
                            <input type="number" 
                                   class="form-control" 
                                   name="field_{{ field.id }}"
                                   {% if field.min_value %}min="{{ field.min_value }}"{% endif %}
                                   {% if field.max_value %}max="{{ field.max_value }}"{% endif %}
                                   step="0.01"
                                   placeholder="{{ field.placeholder }}"
                                   {% if field.is_required %}required{% endif %}
                                   value="{% if is_edit and field.id in field_responses %}{{ field_responses|get_item:field.id|get_item:'value' }}{% elif form_data %}{{ form_data|get_field_value:field.id }}{% else %}{{ field.default_value }}{% endif %}">
                        
                        <!-- DROPDOWN -->
                        {% elif field.field_type == 'dropdown' %}
                            <select class="form-select" 
                                    name="field_{{ field.id }}"
                                    {% if field.is_required %}required{% endif %}>
                                <option value="">Select...</option>
                                {% for choice in field.get_choices_list %}
                                    {% if is_edit and field.id in field_responses %}
                                        <option value="{{ choice }}" {% if field_responses|get_item:field.id|get_item:'value' == choice %}selected{% endif %}>{{ choice }}</option>
                                    {% elif form_data %}
                                        <option value="{{ choice }}" {% if form_data|get_field_value:field.id == choice %}selected{% endif %}>{{ choice }}</option>
                                    {% else %}
                                        <option value="{{ choice }}" {% if field.default_value == choice %}selected{% endif %}>{{ choice }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        
                        <!-- TEXTAREA -->
                        {% elif field.field_type == 'textarea' %}
                            <textarea class="form-control" 
                                      name="field_{{ field.id }}"
                                      rows="3"
                                      placeholder="{{ field.placeholder }}"
                                      {% if field.is_required %}required{% endif %}>{% if is_edit and field.id in field_responses %}{{ field_responses|get_item:field.id|get_item:'value' }}{% elif form_data %}{{ form_data|get_field_value:field.id }}{% else %}{{ field.default_value }}{% endif %}</textarea>
                        
                        <!-- OK/NOK -->
                        {% elif field.field_type == 'ok_nok' %}
                            <div class="btn-group" role="group">
                                <input type="radio" 
                                       class="btn-check" 
                                       name="field_{{ field.id }}" 
                                       id="field_{{ field.id }}_ok" 
                                       value="OK"
                                       {% if is_edit and field.id in field_responses %}
                                           {% if field_responses|get_item:field.id|get_item:'value' == 'OK' %}checked{% endif %}
                                       {% elif form_data %}
                                           {% if form_data|get_field_value:field.id == 'OK' %}checked{% endif %}
                                       {% elif field.default_value == 'OK' %}
                                           checked
                                       {% endif %}>
                                <label class="btn btn-outline-success" for="field_{{ field.id }}_ok">OK</label>
                                
                                <input type="radio" 
                                       class="btn-check" 
                                       name="field_{{ field.id }}" 
                                       id="field_{{ field.id }}_nok" 
                                       value="NOK"
                                       {% if is_edit and field.id in field_responses %}
                                           {% if field_responses|get_item:field.id|get_item:'value' == 'NOK' %}checked{% endif %}
                                       {% elif form_data %}
                                           {% if form_data|get_field_value:field.id == 'NOK' %}checked{% endif %}
                                       {% elif field.default_value == 'NOK' %}
                                           checked
                                       {% endif %}>
                                <label class="btn btn-outline-danger" for="field_{{ field.id }}_nok">NOK</label>
                            </div>
                        
                        <!-- YES/NO -->
                        {% elif field.field_type == 'yes_no' %}
                            <div class="btn-group" role="group">
                                <input type="radio" 
                                       class="btn-check" 
                                       name="field_{{ field.id }}" 
                                       id="field_{{ field.id }}_yes" 
                                       value="Yes"
                                       {% if is_edit and field.id in field_responses %}
                                           {% if field_responses|get_item:field.id|get_item:'value' == 'Yes' %}checked{% endif %}
                                       {% elif form_data %}
                                           {% if form_data|get_field_value:field.id == 'Yes' %}checked{% endif %}
                                       {% elif field.default_value == 'Yes' %}
                                           checked
                                       {% endif %}>
                                <label class="btn btn-outline-success" for="field_{{ field.id }}_yes">Yes</label>
                                
                                <input type="radio" 
                                       class="btn-check" 
                                       name="field_{{ field.id }}" 
                                       id="field_{{ field.id }}_no" 
                                       value="No"
                                       {% if is_edit and field.id in field_responses %}
                                           {% if field_responses|get_item:field.id|get_item:'value' == 'No' %}checked{% endif %}
                                       {% elif form_data %}
                                           {% if form_data|get_field_value:field.id == 'No' %}checked{% endif %}
                                       {% elif field.default_value == 'No' %}
                                           checked
                                       {% endif %}>
                                <label class="btn btn-outline-danger" for="field_{{ field.id }}_no">No</label>
                            </div>
                        
                        <!-- DATE -->
                        {% elif field.field_type == 'date' %}
                            <input type="date" 
                                   class="form-control" 
                                   name="field_{{ field.id }}"
                                   {% if field.is_required %}required{% endif %}
                                   value="{% if is_edit and field.id in field_responses %}{{ field_responses|get_item:field.id|get_item:'value' }}{% elif form_data %}{{ form_data|get_field_value:field.id }}{% else %}{{ field.default_value }}{% endif %}">
                        
                        <!-- TIME -->
                        {% elif field.field_type == 'time' %}
                            <input type="time" 
                                   class="form-control" 
                                   name="field_{{ field.id }}"
                                   {% if field.is_required %}required{% endif %}
                                   value="{% if is_edit and field.id in field_responses %}{{ field_responses|get_item:field.id|get_item:'value' }}{% elif form_data %}{{ form_data|get_field_value:field.id }}{% else %}{{ field.default_value }}{% endif %}">
                        
                        <!-- DATETIME -->
                        {% elif field.field_type == 'datetime' %}
                            <input type="datetime-local" 
                                   class="form-control" 
                                   name="field_{{ field.id }}"
                                   {% if field.is_required %}required{% endif %}
                                   value="{% if is_edit and field.id in field_responses %}{{ field_responses|get_item:field.id|get_item:'value' }}{% elif form_data %}{{ form_data|get_field_value:field.id }}{% else %}{{ field.default_value }}{% endif %}">
                        
                        <!-- CHECKBOX -->
                        {% elif field.field_type == 'checkbox' %}
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       name="field_{{ field.id }}"
                                       id="field_{{ field.id }}"
                                       value="checked"
                                       {% if is_edit and field.id in field_responses %}
                                           {% if field_responses|get_item:field.id|get_item:'value' == 'checked' %}checked{% endif %}
                                       {% elif form_data %}
                                           {% if form_data|get_field_value:field.id == 'checked' %}checked{% endif %}
                                       {% elif field.default_value == 'checked' %}
                                           checked
                                       {% endif %}>
                                <label class="form-check-label" for="field_{{ field.id }}">
                                    {{ field.label }}
                                </label>
                            </div>
                        {% endif %}
                        
                        <!-- STATUS FIELD (if applicable) -->
                        {% if field.has_status_field %}
                            <div class="mt-2">
                                <label class="form-label">Status:</label>
                                <select class="form-select" name="status_{{ field.id }}">
                                    <option value="">Select Status</option>
                                    <option value="OK" 
                                        {% if is_edit and field.id in field_responses %}
                                            {% if field_responses|get_item:field.id|get_item:'status' == 'OK' %}selected{% endif %}
                                        {% elif form_data %}
                                            {% if form_data|get_status_value:field.id == 'OK' %}selected{% endif %}
                                        {% endif %}>OK</option>
                                    <option value="NOK"
                                        {% if is_edit and field.id in field_responses %}
                                            {% if field_responses|get_item:field.id|get_item:'status' == 'NOK' %}selected{% endif %}
                                        {% elif form_data %}
                                            {% if form_data|get_status_value:field.id == 'NOK' %}selected{% endif %}
                                        {% endif %}>NOK</option>
                                </select>
                            </div>
                        {% endif %}
                        
                        <!-- COMMENT FIELD -->
                        <div class="mt-2">
                            <label class="form-label">
                                Comment/Remark
                                {% if field.requires_comment_if_nok %}
                                    <span class="text-muted">(Required if NOK)</span>
                                {% endif %}
                            </label>
                            <textarea class="form-control" 
                                      name="comment_{{ field.id }}"
                                      rows="2"
                                      placeholder="Add comment or remark">{% if is_edit and field.id in field_responses %}{{ field_responses|get_item:field.id|get_item:'comment' }}{% elif form_data %}{{ form_data|get_comment_value:field.id }}{% endif %}</textarea>
                        </div>
                    </div>
                </div>
                <hr>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    
    <!-- Form Actions -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <a href="{% url 'checksheet_list' %}" class="btn btn-secondary">Cancel</a>
                <div>
                    <button type="submit" name="action" value="draft" class="btn btn-warning me-2">
                        <i class="bi bi-save"></i> Save as Draft
                    </button>
                    <button type="submit" name="action" value="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Submit for Approval
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

{% endblock %}

{% block extra_js %}
<script>
// Handle model selection change for auto-fill fields
function handleModelChange(selectedModel) {
    if (!selectedModel) return;
    
    console.log('Model selected:', selectedModel);
    
    // Find all fields with auto-fill
    const autoFillFields = document.querySelectorAll('[data-autofill="true"]');
    
    autoFillFields.forEach(field => {
        const fieldId = field.id.replace('field_', '');
        
        // Make AJAX request to get auto-fill value
        fetch(`{% url 'get_autofill_value' %}?field_id=${fieldId}&model=${selectedModel}`)
            .then(response => response.json())
            .then(data => {
                if (data.value) {
                    field.value = data.value;
                    // Add visual feedback
                    field.style.backgroundColor = '#e8f5e9';
                    setTimeout(() => {
                        field.style.backgroundColor = '';
                    }, 1000);
                }
            })
            .catch(error => console.error('Error fetching auto-fill value:', error));
    });
}

// Toggle comment field visibility
function toggleCommentField(fieldId, isRequired) {
    const commentField = document.getElementById(`comment_field_${fieldId}`);
    const nokRadio = document.getElementById(`nok_${fieldId}`) || 
                     document.getElementById(`status_nok_${fieldId}`) ||
                     document.getElementById(`no_${fieldId}`);
    
    if (commentField) {
        if (nokRadio && nokRadio.checked) {
            commentField.style.display = 'block';
            if (isRequired) {
                document.getElementById(`comment_${fieldId}`).required = true;
            }
        } else {
            commentField.style.display = 'none';
            document.getElementById(`comment_${fieldId}`).required = false;
        }
    }
}

// Form validation before submit
document.getElementById('checksheetForm').addEventListener('submit', function(e) {
    const action = e.submitter.value;
    
    if (action === 'submit') {
        // Additional validation for submit action
        let hasErrors = false;
        const requiredFields = this.querySelectorAll('[required]');
        
        requiredFields.forEach(field => {
            if (!field.value && field.type !== 'radio') {
                hasErrors = true;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        // Check radio groups
        const radioGroups = {};
        this.querySelectorAll('input[type="radio"][required]').forEach(radio => {
            if (!radioGroups[radio.name]) {
                radioGroups[radio.name] = [];
            }
            radioGroups[radio.name].push(radio);
        });
        
        Object.keys(radioGroups).forEach(groupName => {
            const group = radioGroups[groupName];
            const isChecked = group.some(radio => radio.checked);
            if (!isChecked) {
                hasErrors = true;
                group.forEach(radio => {
                    radio.parentElement.classList.add('is-invalid');
                });
            }
        });
        
        if (hasErrors) {
            e.preventDefault();
            alert('Please fill in all required fields before submitting.');
            // Scroll to first error
            const firstError = this.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }
});

// Initialize comment fields on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check all NOK radio buttons and show comment fields if needed
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        if (radio.value === 'NOK' || radio.value === 'No') {
            const fieldId = radio.id.replace('nok_', '').replace('status_nok_', '').replace('no_', '');
            const commentField = document.getElementById(`comment_field_${fieldId}`);
            if (commentField) {
                commentField.style.display = 'block';
            }
        }
    });
});
</script>

<style>
.is-invalid {
    border-color: #dc3545 !important;
}

.btn-check:checked + .btn-outline-success {
    background-color: var(--success-color);
    color: white;
}

.btn-check:checked + .btn-outline-danger {
    background-color: var(--danger-color);
    color: white;
}

.field-wrapper {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.comment-field {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.field-wrapper{
    background-color: #111
}

.card-body{
        background-color: #111

}
</style>
{% endblock %}